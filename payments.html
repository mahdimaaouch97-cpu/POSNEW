<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدفع والإيصالات</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <header>
        <h1>الدفع والإيصالات</h1>
        <nav>
            <ul>
                <li><a href="index.html">الرئيسية</a></li>
                <li><a href="subscribers.html">المشتركين</a></li>
                <li><a href="payments.html" class="active">الدفع</a></li>
                <li><a href="packages.html">الباقات</a></li>
                <li><a href="receipts.html">الإيصالات</a></li>
                <li><a href="report.html">التقارير</a></li>
                <li><a href="login.html">تسجيل الخروج</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="payments-section">
            <h2>تسجيل دفع جديد</h2>

            <form id="paymentForm">
                <label>اسم المشترك:</label>
                <input type="text" id="subscriberName" required placeholder="أدخل اسم المشترك">

                <label>الباقة:</label>
                <select id="packageSelect" required>
                    <option value="">اختر الباقة</option>
                </select>

                <label>السعر ($):</label>
                <input type="text" id="packagePrice" readonly>

                <button type="submit">تسجيل الدفع وإنشاء إيصال</button>
            </form>
        </section>
    </main>

    <footer>
        <p>© 2026 FAST NET. جميع الحقوق محفوظة.</p>
    </footer>

    <script>
        // --- تحميل الباقات من LocalStorage ---
        let packages = JSON.parse(localStorage.getItem("packages")) || [];
        let receipts = JSON.parse(localStorage.getItem("receipts")) || [];

        const packageSelect = document.getElementById("packageSelect");
        const packagePrice = document.getElementById("packagePrice");

        // عرض الباقات في select
        packages.forEach(pkg => {
            const option = document.createElement("option");
            option.value = pkg.name;
            option.dataset.price = pkg.price;
            option.textContent = pkg.name;
            packageSelect.appendChild(option);
        });

        // عند اختيار الباقة، يظهر السعر تلقائيًا
        packageSelect.addEventListener("change", () => {
            const selectedOption = packageSelect.selectedOptions[0];
            packagePrice.value = selectedOption.dataset.price || "";
        });

        // --- عند إرسال النموذج ---
        document.getElementById("paymentForm").addEventListener("submit", function(e) {
            e.preventDefault();

            const subscriber = document.getElementById("subscriberName").value.trim();
            const pkgName = packageSelect.value;
            const price = packagePrice.value;

            if(!subscriber || !pkgName || !price) {
                alert("يرجى ملء جميع الحقول!");
                return;
            }

            // إنشاء رقم إيصال تلقائي
            const receiptId = receipts.length ? receipts[receipts.length - 1].id + 1 : 1;
            const date = new Date().toLocaleDateString();

            const newReceipt = {
                id: receiptId,
                subscriber: subscriber,
                package: pkgName,
                price: parseFloat(price).toFixed(2),
                date: date
            };

            receipts.push(newReceipt);
            localStorage.setItem("receipts", JSON.stringify(receipts));

            alert("تم تسجيل الدفع وإنشاء الإيصال!");

            // طباعة الإيصال مباشرة
            const printWindow = window.open('', '', 'width=400,height=600');
            printWindow.document.write(`
                <html>
                <head>
                    <title>طباعة الإيصال</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h2 { text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                    </style>
                </head>
                <body>
                    <h2>إيصال دفع</h2>
                    <table>
                        <tr><th>رقم الإيصال:</th><td>${newReceipt.id}</td></tr>
                        <tr><th>اسم المشترك:</th><td>${newReceipt.subscriber}</td></tr>
                        <tr><th>الباقة:</th><td>${newReceipt.package}</td></tr>
                        <tr><th>السعر ($):</th><td>$${newReceipt.price}</td></tr>
                        <tr><th>التاريخ:</th><td>${newReceipt.date}</td></tr>
                    </table>
                    <p style="text-align:center; margin-top:20px;">شكراً لاستخدامكم FAST NET</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();

            // إعادة تعيين النموذج
            this.reset();
            packagePrice.value = "";
        });
    </script>
</body>
</html>
