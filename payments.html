<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الدفع والإيصالات</title>
<link rel="stylesheet" href="assets/css/style.css">
<style>
form { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
form input, form select, form button { padding:8px; border-radius:5px; border:1px solid #ccc; flex:1 1 150px; }
form button { flex:0 0 auto; }
</style>
</head>
<body>
<header>
<h1>الدفع والإيصالات</h1>
<nav>
<ul>
<li><a href="index.html">الرئيسية</a></li>
<li><a href="subscribers.html">المشتركين</a></li>
<li><a href="payments.html" class="active">الدفع</a></li>
<li><a href="packages.html">الباقات</a></li>
<li><a href="receipts.html">الإيصالات</a></li>
<li><a href="report.html">التقارير</a></li>
<li><a href="login.html">تسجيل الخروج</a></li>
</ul>
</nav>
</header>

<main>
<section class="payments-section">
<h2>تسجيل دفع جديد</h2>

<form id="paymentForm">
<select id="subscriberSelect" required>
<option value="">اختر المشترك</option>
</select>
<input type="text" id="packageName" placeholder="الباقة" readonly>
<input type="number" id="packagePrice" placeholder="سعر الاشتراك ($)" readonly>
<input type="number" id="paidSoFar" placeholder="المبلغ المدفوع حتى الآن ($)" readonly>
<input type="number" id="payAmount" placeholder="المبلغ المراد دفعه ($)" min="0" required>
<button type="submit">تسجيل الدفع وإنشاء إيصال</button>
</form>
</section>
</main>

<footer>
<p>© 2026 FAST NET. جميع الحقوق محفوظة.</p>
</footer>

<script>
// تحميل البيانات
let subscribers = JSON.parse(localStorage.getItem("subscribers")) || [];
let packages = JSON.parse(localStorage.getItem("packages")) || [];
let receipts = JSON.parse(localStorage.getItem("receipts")) || [];

// تعبئة قائمة المشتركين
const subscriberSelect = document.getElementById("subscriberSelect");
subscribers.forEach((sub,index)=>{
    const option = document.createElement("option");
    option.value = index; // index في المصفوفة
    option.textContent = sub.name;
    subscriberSelect.appendChild(option);
});

// عند اختيار مشترك، عرض بياناته
subscriberSelect.addEventListener("change", ()=>{
    const index = subscriberSelect.value;
    if(index==="") {
        document.getElementById("packageName").value = "";
        document.getElementById("packagePrice").value = "";
        document.getElementById("paidSoFar").value = "";
        return;
    }
    const sub = subscribers[index];
    const pkgPrice = packages.find(p=>p.name===sub.package)?.price || 0;
    document.getElementById("packageName").value = sub.package;
    document.getElementById("packagePrice").value = parseFloat(pkgPrice).toFixed(2);
    document.getElementById("paidSoFar").value = parseFloat(sub.paid || 0).toFixed(2);
});

// عند إرسال النموذج
document.getElementById("paymentForm").addEventListener("submit", function(e){
    e.preventDefault();
    const index = subscriberSelect.value;
    if(index==="") return alert("اختر مشتركاً!");
    const payAmount = parseFloat(document.getElementById("payAmount").value);
    if(isNaN(payAmount) || payAmount<=0) return alert("أدخل مبلغ صحيح!");

    const sub = subscribers[index];
    const pkgPrice = parseFloat(packages.find(p=>p.name===sub.package)?.price || 0);
    sub.paid = parseFloat(sub.paid || 0) + payAmount;
    const remaining = pkgPrice - sub.paid;

    // حفظ البيانات في LocalStorage
    subscribers[index] = sub;
    localStorage.setItem("subscribers", JSON.stringify(subscribers));

    // إنشاء إيصال
    const receiptId = receipts.length ? receipts[receipts.length-1].id+1 : 1;
    const date = new Date().toLocaleDateString();
    const newReceipt = {
        id: receiptId,
        subscriber: sub.name,
        package: sub.package,
        price: payAmount.toFixed(2),
        date: date
    };
    receipts.push(newReceipt);
    localStorage.setItem("receipts", JSON.stringify(receipts));

    alert(`تم تسجيل الدفع! المبلغ المتبقي: $${(remaining).toFixed(2)}`);

    // طباعة الإيصال
    const printWindow = window.open('','', 'width=400,height=600');
    printWindow.document.write(`
        <html><head><title>إيصال الدفع</title><style>
        body{font-family:Arial;padding:20px;}
        h2{text-align:center;}
        table{width:100%;border-collapse:collapse;margin-top:20px;}
        th,td{border:1px solid #000;padding:8px;text-align:left;}
        </style></head>
        <body>
        <h2>إيصال دفع</h2>
        <table>
        <tr><th>رقم الإيصال:</th><td>${newReceipt.id}</td></tr>
        <tr><th>اسم المشترك:</th><td>${newReceipt.subscriber}</td></tr>
        <tr><th>الباقة:</th><td>${newReceipt.package}</td></tr>
        <tr><th>المبلغ المدفوع ($):</th><td>$${newReceipt.price}</td></tr>
        <tr><th>التاريخ:</th><td>${newReceipt.date}</td></tr>
        </table>
        <p style="text-align:center;margin-top:20px;">شكراً لاستخدامكم FAST NET</p>
        </body></html>
    `);
    printWindow.document.close();
    printWindow.print();

    // إعادة تعيين النموذج
    this.reset();
    document.getElementById("packageName").value = "";
    document.getElementById("packagePrice").value = "";
    document.getElementById("paidSoFar").value = "";
});
</script>
</body>
</html>
