<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الدفع - FAST NET</title>
<link rel="stylesheet" href="assets/css/style.css">
<style>
body{font-family:Arial; background:#f5f5f5; margin:0; padding:0;}
header{background:#007bff; color:#fff; padding:20px; text-align:center;}
nav ul{display:flex; justify-content:center; list-style:none; padding:0; margin:10px 0 0; gap:10px; flex-wrap:wrap;}
nav ul li a{color:#fff; text-decoration:none; padding:10px 15px; background:#0056b3; border-radius:5px;}
nav ul li a:hover, nav ul li a.active{background:#003f7f;}
main{padding:20px;}
form input, form select, form button{padding:8px; margin:5px 0; border-radius:5px; border:1px solid #ccc;}
form button{border:none; background:#28a745; color:#fff; cursor:pointer; transition:0.3s;}
form button:hover{background:#218838;}
table{width:100%; border-collapse:collapse; margin-top:10px; background:#fff;}
th,td{border:1px solid #000; padding:8px; text-align:center;}
</style>
</head>
<body>

<header>
<h1>الدفع - FAST NET</h1>
<nav>
<ul>
<li><a href="index.html">الرئيسية</a></li>
<li><a href="subscribers.html">المشتركين</a></li>
<li><a href="packages.html">الباقات</a></li>
<li><a href="payments.html" class="active">الدفع</a></li>
<li><a href="receipts.html">الإيصالات</a></li>
<li><a href="search.html">بحث المشتركين</a></li>
<li><a href="report.html">التقارير</a></li>
</ul>
</nav>
</header>

<main>
<h2>تسجيل دفعة جديدة</h2>
<form id="paymentForm">
<select id="subscriberSelect" required></select>
<input type="number" id="paymentAmount" placeholder="المبلغ ($)" min="1" required>
<button type="submit">تسجيل الدفع</button>
</form>

<h3>دفعات المشتركين</h3>
<table id="paymentsTable">
<thead>
<tr>
<th>الرقم</th>
<th>الاسم</th>
<th>الباقة</th>
<th>المبلغ المدفوع ($)</th>
<th>المبلغ المتبقي ($)</th>
<th>الإجراءات</th>
</tr>
</thead>
<tbody></tbody>
</table>
</main>

<footer style="text-align:center; padding:15px; background:#007bff; color:#fff;">
<p>© 2026 FAST NET. جميع الحقوق محفوظة.</p>
</footer>

<script>
let subscribers = JSON.parse(localStorage.getItem("subscribers")) || [];
let packages = JSON.parse(localStorage.getItem("packages")) || [];
let receipts = JSON.parse(localStorage.getItem("receipts")) || [];

const subscriberSelect = document.getElementById("subscriberSelect");

function fillSubscribersDropdown(){
    subscriberSelect.innerHTML="";
    subscribers.forEach((sub,index)=>{
        const option = document.createElement("option");
        option.value = index;
        option.textContent = sub.name;
        subscriberSelect.appendChild(option);
    });
}

fillSubscribersDropdown();

function renderPayments(){
    const tbody = document.querySelector("#paymentsTable tbody");
    tbody.innerHTML="";
    subscribers.forEach((sub,index)=>{
        const pkgPrice = packages.find(p=>p.name===sub.package)?.price || 0;
        const remaining = (pkgPrice - sub.paid).toFixed(2);
        const row = document.createElement("tr");
        row.innerHTML=`
        <td>${index+1}</td>
        <td>${sub.name}</td>
        <td>${sub.package}</td>
        <td>$${sub.paid.toFixed(2)}</td>
        <td>$${remaining}</td>
        <td><button onclick="printReceipt(${index})">طباعة الإيصال</button></td>
        `;
        tbody.appendChild(row);
    });
}

document.getElementById("paymentForm").addEventListener("submit", function(e){
    e.preventDefault();
    const subIndex = parseInt(subscriberSelect.value);
    const amount = parseFloat(document.getElementById("paymentAmount").value);
    if(isNaN(amount) || amount <=0) return alert("أدخل مبلغ صالح!");
    subscribers[subIndex].paid += amount;

    // إنشاء إيصال
    const receipt = {
        subscriber: subscribers[subIndex].name,
        package: subscribers[subIndex].package,
        paid: amount,
        date: new Date().toLocaleDateString()
    };
    receipts.push(receipt);

    localStorage.setItem("subscribers", JSON.stringify(subscribers));
    localStorage.setItem("receipts", JSON.stringify(receipts));
    renderPayments();
    document.getElementById("paymentForm").reset();
});

function printReceipt(index){
    const sub = subscribers[index];
    const pkgPrice = packages.find(p=>p.name===sub.package)?.price || 0;
    const remaining = (pkgPrice - sub.paid).toFixed(2);
    const printWindow = window.open('','', 'width=400,height=600');
    printWindow.document.write(`
        <html><head><title>إيصال الدفع</title>
        <style>body{font-family:Arial;padding:20px;} h2{text-align:center;} table{width:100%;border-collapse:collapse;margin-top:20px;} th,td{border:1px solid #000;padding:8px;text-align:left;}</style>
        </head>
        <body>
        <h2>إيصال الدفع</h2>
        <table>
        <tr><th>الاسم:</th><td>${sub.name}</td></tr>
        <tr><th>الباقة:</th><td>${sub.package}</td></tr>
        <tr><th>المبلغ المدفوع ($):</th><td>$${sub.paid.toFixed(2)}</td></tr>
        <tr><th>المبلغ المتبقي ($):</th><td>$${remaining}</td></tr>
        <tr><th>التاريخ:</th><td>${new Date().toLocaleDateString()}</td></tr>
        </table>
        <p style="text-align:center;margin-top:20px;">شكراً لاستخدامكم FAST NET</p>
        </body></html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// عرض الدفعات عند تحميل الصفحة
renderPayments();
</script>

</body>
</html>
